
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>minisql &#8212; miniSQL 1.0.0 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for minisql</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="c1"># TODO: implement autocomplete feature</span>
<span class="c1"># TODO: fix readline history read / write</span>
<span class="c1"># TODO: fix error in query execution (double loop? found during inserts)</span>
<span class="c1"># TODO: add error handling</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">stat</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">readline</span><span class="o">,</span> <span class="nn">weakref</span><span class="o">,</span> <span class="nn">struct</span><span class="o">,</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">settings</span>


<span class="c1"># constants</span>
<span class="n">WHITE_SPACE_NOT_ENCLOSED</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;\s+(?=(?:[^</span><span class="se">\&quot;\&#39;</span><span class="s1">]*</span><span class="se">\&quot;</span><span class="s1">[^</span><span class="se">\&quot;\&#39;</span><span class="s1">]*</span><span class="se">\&quot;</span><span class="s1">)*[^</span><span class="se">\&quot;\&#39;</span><span class="s1">]*$)|\s+(?=(?:[^</span><span class="se">\&quot;\&#39;</span><span class="s1">]*</span><span class="se">\&#39;</span><span class="s1">[^</span><span class="se">\&quot;\&#39;</span><span class="s1">]*</span><span class="se">\&#39;</span><span class="s1">)*[^</span><span class="se">\&quot;\&#39;</span><span class="s1">]*$)&#39;</span><span class="p">,</span>
                                      <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="o">|</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
<span class="n">POSSIBLE_SHELL_COMMANDS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;help&#39;</span><span class="p">,</span> <span class="s1">&#39;insert&#39;</span><span class="p">,</span> <span class="s1">&#39;retrieve&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="s1">&#39;quit&#39;</span><span class="p">}</span>

<span class="c1"># functions</span>
<div class="viewcode-block" id="supportsColor"><a class="viewcode-back" href="../index.html#minisql.supportsColor">[docs]</a><span class="k">def</span> <span class="nf">supportsColor</span><span class="p">(</span><span class="n">stream</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if terminal supports ASCII color codes\n</span>
<span class="sd">    Modified method from Python cookbook, #475186</span>

<span class="sd">    :param stream: file stream to check</span>
<span class="sd">    :return: True == supported, False == not supported</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s2">&quot;isatty&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">stream</span><span class="o">.</span><span class="n">isatty</span><span class="p">():</span>
        <span class="c1"># auto color only on TTYs</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">curses</span>
        <span class="n">curses</span><span class="o">.</span><span class="n">setupterm</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">curses</span><span class="o">.</span><span class="n">tigetnum</span><span class="p">(</span><span class="s2">&quot;colors&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c1"># guess false in case of error</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<span class="k">def</span> <span class="nf">printCmdUsage</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;|============== miniSQL Cmd Usage ==============|</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;| minisql.py [-h] | [-v] | [-e &lt;query&gt;]         |</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;|================ Cmd Arguments ================|</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;| (no args)        Start miniSQL shell          |</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;| -h               Show this usage information  |</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;| -v               Show miniSQL version         |</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;| -e &lt;query&gt;       Execute miniSQL query        |</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;| -s &lt;ip&gt;:&lt;port&gt;   Serve queries from network   |</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;|================= Extra Notes =================|</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;| miniSQL will execute commands as provided     |</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;| by stdin if redirected in parent shell        |</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;|===============================================|</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">printShellUsage</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;|============= miniSQL Shell Usage =============|</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;| Keywords are case insensitive                 |</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;| Optionally shortened versions can be used     |</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;| Each record contain a name and 4 fields       |</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;| Fields are restricted to positive integers    |</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;|========= Show this usage information =========|</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;| miniSQL&gt; H;                                   |</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;| miniSQL&gt; HELP;                                |</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;|=============== Insert a record ===============|</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;| miniSQL&gt; I &lt;record&gt; &lt;a1&gt; &lt;a2&gt; &lt;a3&gt; &lt;a4&gt;;      |</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;| miniSQL&gt; INSERT &lt;record&gt; &lt;a1&gt; &lt;a2&gt; &lt;a3&gt; &lt;a4&gt;; |</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;|=============== Retrieve a record =============|</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;| miniSQL&gt; R &lt;record&gt;;                          |</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;| miniSQL&gt; RETRIEVE &lt;record&gt;;                   |</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;| miniSQL&gt; RETRIEVE *;                          |</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;|=============== Delete a record ===============|</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;| miniSQL&gt; D &lt;record&gt;;                          |</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;| miniSQL&gt; DELETE &lt;record&gt;;                     |</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;| miniSQL&gt; DELETE *;                            |</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;|=============== Update a record ===============|</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;| miniSQL&gt; U &lt;record&gt; &lt;field&gt;=&lt;value&gt;;          |</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;| miniSQL&gt; UPDATE &lt;record&gt; &lt;field&gt;=&lt;value&gt;;     |</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;|================ Quit program =================|</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;| miniSQL&gt; Q;                                   |</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;| miniSQL&gt; QUIT;                                |</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;|===============================================|</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">printerr</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">supportsColor</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[1;31m[ERROR]: </span><span class="si">{}</span><span class="se">\x1b</span><span class="s2">[0m&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[ERROR]: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>

<span class="k">def</span> <span class="nf">printwarn</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">supportsColor</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[1;33m[WARNING]: </span><span class="si">{}</span><span class="se">\x1b</span><span class="s2">[0m&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[WARNING]: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>

<span class="k">def</span> <span class="nf">printdbg</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">supportsColor</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[1;34m[DEBUG]: </span><span class="si">{}</span><span class="se">\x1b</span><span class="s2">[0m&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DEBUG]: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>


<div class="viewcode-block" id="printTable"><a class="viewcode-back" href="../index.html#minisql.printTable">[docs]</a><span class="k">def</span> <span class="nf">printTable</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">num_rows</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;block&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Print in table format</span>

<span class="sd">    :param headers:  list of strings</span>
<span class="sd">    :param data:     list of lists (rows)</span>
<span class="sd">    :param num_rows: int</span>
<span class="sd">    :param fmt:      str format type</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># settings for different formats</span>
    <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;block&#39;</span><span class="p">:</span>
        <span class="n">col_delim</span> <span class="o">=</span> <span class="s2">&quot;||&quot;</span>
        <span class="n">top_section_start</span> <span class="o">=</span> <span class="s2">&quot;//&quot;</span>
        <span class="n">top_section_end</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span>
        <span class="n">top_section_row_delim</span> <span class="o">=</span> <span class="s2">&quot;=&quot;</span>
        <span class="n">top_section_col_delim</span> <span class="o">=</span> <span class="s2">&quot;||&quot;</span>
        <span class="n">middle_section_start</span> <span class="o">=</span> <span class="s2">&quot;|]&quot;</span>
        <span class="n">middle_section_end</span> <span class="o">=</span> <span class="s2">&quot;[|&quot;</span>
        <span class="n">middle_section_row_delim</span> <span class="o">=</span> <span class="s2">&quot;=&quot;</span>
        <span class="n">middle_section_col_delim</span> <span class="o">=</span> <span class="s2">&quot;[]&quot;</span>
        <span class="n">bottom_section_start</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span>
        <span class="n">bottom_section_end</span> <span class="o">=</span> <span class="s2">&quot;//&quot;</span>
        <span class="n">bottom_section_row_delim</span> <span class="o">=</span> <span class="s2">&quot;=&quot;</span>
        <span class="n">bottom_section_col_delim</span> <span class="o">=</span> <span class="s2">&quot;||&quot;</span>
        <span class="n">include_top_section</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">include_middle_sction</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">include_bottom_section</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;mysql&#39;</span><span class="p">:</span>
        <span class="n">col_delim</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span>
        <span class="n">top_section_start</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>
        <span class="n">top_section_end</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>
        <span class="n">top_section_row_delim</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
        <span class="n">top_section_col_delim</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>
        <span class="n">middle_section_start</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>
        <span class="n">middle_section_end</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>
        <span class="n">middle_section_row_delim</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
        <span class="n">middle_section_col_delim</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>
        <span class="n">bottom_section_start</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>
        <span class="n">bottom_section_end</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>
        <span class="n">bottom_section_row_delim</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
        <span class="n">bottom_section_col_delim</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>
        <span class="n">include_top_section</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">include_middle_sction</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">include_bottom_section</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;md&#39;</span><span class="p">:</span>
        <span class="n">col_delim</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span>
        <span class="n">top_section_start</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">top_section_end</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">top_section_row_delim</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
        <span class="n">top_section_col_delim</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span>
        <span class="n">middle_section_start</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span>
        <span class="n">middle_section_end</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span>
        <span class="n">middle_section_row_delim</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
        <span class="n">middle_section_col_delim</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span>
        <span class="n">bottom_section_start</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">bottom_section_end</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">bottom_section_row_delim</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
        <span class="n">bottom_section_col_delim</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span>
        <span class="n">include_top_section</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">include_middle_sction</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">include_bottom_section</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;rst&#39;</span><span class="p">:</span>
        <span class="n">col_delim</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span>
        <span class="n">top_section_start</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>
        <span class="n">top_section_end</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>
        <span class="n">top_section_row_delim</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
        <span class="n">top_section_col_delim</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>
        <span class="n">middle_section_start</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>
        <span class="n">middle_section_end</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>
        <span class="n">middle_section_row_delim</span> <span class="o">=</span> <span class="s2">&quot;=&quot;</span>
        <span class="n">middle_section_col_delim</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>
        <span class="n">bottom_section_start</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>
        <span class="n">bottom_section_end</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>
        <span class="n">bottom_section_row_delim</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
        <span class="n">bottom_section_col_delim</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>
        <span class="n">include_top_section</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">include_middle_sction</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">include_bottom_section</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;unicode&#39;</span><span class="p">:</span>
        <span class="n">col_delim</span> <span class="o">=</span> <span class="s2">&quot;║&quot;</span>
        <span class="n">top_section_start</span> <span class="o">=</span> <span class="s2">&quot;╔&quot;</span>
        <span class="n">top_section_end</span> <span class="o">=</span> <span class="s2">&quot;╗&quot;</span>
        <span class="n">top_section_row_delim</span> <span class="o">=</span> <span class="s2">&quot;═&quot;</span>
        <span class="n">top_section_col_delim</span> <span class="o">=</span> <span class="s2">&quot;╦&quot;</span>
        <span class="n">middle_section_start</span> <span class="o">=</span> <span class="s2">&quot;╠&quot;</span>
        <span class="n">middle_section_end</span> <span class="o">=</span> <span class="s2">&quot;╣&quot;</span>
        <span class="n">middle_section_row_delim</span> <span class="o">=</span> <span class="s2">&quot;═&quot;</span>
        <span class="n">middle_section_col_delim</span> <span class="o">=</span> <span class="s2">&quot;╬&quot;</span>
        <span class="n">bottom_section_start</span> <span class="o">=</span> <span class="s2">&quot;╚&quot;</span>
        <span class="n">bottom_section_end</span> <span class="o">=</span> <span class="s2">&quot;╝&quot;</span>
        <span class="n">bottom_section_row_delim</span> <span class="o">=</span> <span class="s2">&quot;═&quot;</span>
        <span class="n">bottom_section_col_delim</span> <span class="o">=</span> <span class="s2">&quot;╩&quot;</span>
        <span class="n">include_top_section</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">include_middle_sction</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">include_bottom_section</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">col_delim</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">top_section_start</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">top_section_end</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">top_section_row_delim</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">top_section_col_delim</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">middle_section_start</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">middle_section_end</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">middle_section_row_delim</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">middle_section_col_delim</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">bottom_section_start</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">bottom_section_end</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">bottom_section_row_delim</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">bottom_section_col_delim</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">include_top_section</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">include_middle_sction</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">include_bottom_section</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># calculations for formatting</span>
    <span class="n">num_cols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
    <span class="n">col_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">col_string</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{col_delim}</span><span class="s2">{:^</span><span class="si">{col_width}</span><span class="s2">}&quot;</span> <span class="o">*</span> <span class="n">num_cols</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{col_delim}</span><span class="s2">&quot;</span>

    <span class="c1"># top section</span>
    <span class="k">if</span> <span class="n">include_top_section</span><span class="p">:</span>
        <span class="n">top_section</span> <span class="o">=</span> <span class="n">top_section_start</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_cols</span><span class="p">):</span>
            <span class="n">top_section</span> <span class="o">+=</span> <span class="p">(</span><span class="n">top_section_row_delim</span> <span class="o">*</span> <span class="n">col_width</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">num_cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">top_section</span> <span class="o">+=</span> <span class="n">top_section_col_delim</span>
        <span class="n">top_section</span> <span class="o">+=</span> <span class="n">top_section_end</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">top_section</span><span class="p">)</span>

    <span class="c1"># headers section</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">col_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">headers</span><span class="p">,</span> <span class="n">col_width</span><span class="o">=</span><span class="n">col_width</span><span class="p">,</span> <span class="n">col_delim</span><span class="o">=</span><span class="n">col_delim</span><span class="p">))</span>

    <span class="c1"># middle section</span>
    <span class="k">if</span> <span class="n">include_middle_sction</span><span class="p">:</span>
        <span class="n">middle_section</span> <span class="o">=</span> <span class="n">middle_section_start</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_cols</span><span class="p">):</span>
            <span class="n">middle_section</span> <span class="o">+=</span> <span class="p">(</span><span class="n">middle_section_row_delim</span> <span class="o">*</span> <span class="n">col_width</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">num_cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">middle_section</span> <span class="o">+=</span> <span class="n">middle_section_col_delim</span>
        <span class="n">middle_section</span> <span class="o">+=</span> <span class="n">middle_section_end</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">middle_section</span><span class="p">)</span>

    <span class="c1"># data section</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">num_rows</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">num_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_rows</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">col_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="n">col_width</span><span class="o">=</span><span class="n">col_width</span><span class="p">,</span> <span class="n">col_delim</span><span class="o">=</span><span class="n">col_delim</span><span class="p">))</span>

    <span class="c1"># bottom section</span>
    <span class="k">if</span> <span class="n">include_bottom_section</span><span class="p">:</span>
        <span class="n">bottom_section</span> <span class="o">=</span> <span class="n">bottom_section_start</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_cols</span><span class="p">):</span>
            <span class="n">bottom_section</span> <span class="o">+=</span> <span class="p">(</span><span class="n">bottom_section_row_delim</span> <span class="o">*</span> <span class="n">col_width</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">num_cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">bottom_section</span> <span class="o">+=</span> <span class="n">bottom_section_col_delim</span>
        <span class="n">bottom_section</span> <span class="o">+=</span> <span class="n">bottom_section_end</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">bottom_section</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="validateStdinReadable"><a class="viewcode-back" href="../index.html#minisql.validateStdinReadable">[docs]</a><span class="k">def</span> <span class="nf">validateStdinReadable</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if stdin has been redirected by parent shell\n</span>

<span class="sd">    See the following table for supported input types.\n</span>
<span class="sd">    Note that as of python v3.3 symlinks are followed by default.</span>

<span class="sd">    +------------+-----------+-----------------+</span>
<span class="sd">    | Stdin Type | Supported | Program Context |</span>
<span class="sd">    +============+===========+=================+</span>
<span class="sd">    | directory  | no        |                 |</span>
<span class="sd">    +------------+-----------+-----------------+</span>
<span class="sd">    | keyboard   | yes       | miniSQL shell   |</span>
<span class="sd">    +------------+-----------+-----------------+</span>
<span class="sd">    | storage    | no        |                 |</span>
<span class="sd">    +------------+-----------+-----------------+</span>
<span class="sd">    | file       | yes       | miniSQL cmd     |</span>
<span class="sd">    +------------+-----------+-----------------+</span>
<span class="sd">    | symlink    | no        |                 |</span>
<span class="sd">    +------------+-----------+-----------------+</span>
<span class="sd">    | pipe       | yes       | miniSQL cmd     |</span>
<span class="sd">    +------------+-----------+-----------------+</span>
<span class="sd">    | socket     | no        |                 |</span>
<span class="sd">    +------------+-----------+-----------------+</span>

<span class="sd">    :return: not readable == -1, 0 == readable in cmd, 1 == readable in shell</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">mode</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span><span class="o">.</span><span class="n">st_mode</span>

    <span class="c1"># stdin is a pipe</span>
    <span class="k">if</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISFIFO</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="c1"># stdin is a file</span>
    <span class="k">elif</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="c1"># stdin is a keyboard</span>
    <span class="k">elif</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISCHR</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="c1"># stdin is a directory</span>
    <span class="k">elif</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IFDIR</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="c1"># stdin is a symlink</span>
    <span class="k">elif</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISLNK</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="c1"># stdin is a socket</span>
    <span class="k">elif</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IFSOCK</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="c1"># stdin is a storage device</span>
    <span class="k">elif</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IFBLK</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="c1"># stdin is an unknown device type</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span></div>

<span class="c1"># classes</span>
<div class="viewcode-block" id="MiniDB"><a class="viewcode-back" href="../index.html#minisql.MiniDB">[docs]</a><span class="k">class</span> <span class="nc">MiniDB</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Access to DB, lower level storage operations, and higher level api (querying)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db_file</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">DB_STORAGE_FILE</span>
    <span class="n">record_size</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">DB_RECORD_SIZE</span>
    <span class="n">name_size</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">DB_RECORD_NAME_SIZE</span>
    <span class="n">field_size</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">DB_FIELD_DATA_SIZE</span>
    <span class="n">encoding</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">DB_ENCODING</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Database initialization / connection</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_file</span><span class="p">):</span>
            <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r+b&#39;</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">record_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finalizer</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>

<div class="viewcode-block" id="MiniDB.close"><a class="viewcode-back" href="../index.html#minisql.MiniDB.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close database connection and cleanup</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="MiniDB.recordExists"><a class="viewcode-back" href="../index.html#minisql.MiniDB.recordExists">[docs]</a>    <span class="k">def</span> <span class="nf">recordExists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if database record exists</span>

<span class="sd">        :param name: record name</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :return: True | False</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">record_size</span><span class="p">)</span>

            <span class="c1"># EOF hit</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">record</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="c1"># recall:  l[from:to]  the to is not zero-indexed</span>
            <span class="k">if</span> <span class="n">record</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">name_size</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="MiniDB.getRecord"><a class="viewcode-back" href="../index.html#minisql.MiniDB.getRecord">[docs]</a>    <span class="k">def</span> <span class="nf">getRecord</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get record from database</span>

<span class="sd">        :param name: record name</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :return: tuple(&lt;name&gt;, &lt;a1&gt;, &lt;a2&gt;, &lt;a3&gt;, &lt;a4&gt;) | None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">record_size</span><span class="p">)</span>

            <span class="c1"># EOF hit</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">record</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">record</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">name_size</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="n">record</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">name_size</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">),</span>
                    <span class="o">*</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&gt;IxIxIxI&#39;</span><span class="p">,</span> <span class="n">record</span><span class="p">[</span><span class="mi">19</span><span class="p">:</span><span class="mi">38</span><span class="p">])</span>
                <span class="p">)</span></div>

<div class="viewcode-block" id="MiniDB.getRecords"><a class="viewcode-back" href="../index.html#minisql.MiniDB.getRecords">[docs]</a>    <span class="k">def</span> <span class="nf">getRecords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get aal records from database</span>

<span class="sd">        :param name: record name</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :return: list(tuple(&lt;name&gt;, &lt;a1&gt;, &lt;a2&gt;, &lt;a3&gt;, &lt;a4&gt;)) | [()]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">record_size</span><span class="p">)</span>

            <span class="c1"># EOF hit</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">record</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">records</span>

            <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                <span class="n">record</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">name_size</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">),</span>
                <span class="o">*</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&gt;IxIxIxI&#39;</span><span class="p">,</span> <span class="n">record</span><span class="p">[</span><span class="mi">19</span><span class="p">:</span><span class="mi">38</span><span class="p">])</span>
            <span class="p">))</span></div>



<div class="viewcode-block" id="MiniDB.createRecord"><a class="viewcode-back" href="../index.html#minisql.MiniDB.createRecord">[docs]</a>    <span class="k">def</span> <span class="nf">createRecord</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a record in the database</span>

<span class="sd">        :param name: record name</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :param a1: field data</span>
<span class="sd">        :type a1: int</span>
<span class="sd">        :param a2: field data</span>
<span class="sd">        :type a2: int</span>
<span class="sd">        :param a3: field data</span>
<span class="sd">        :type a3: int</span>
<span class="sd">        :param a4: field data</span>
<span class="sd">        :type a4: int</span>
<span class="sd">        :return: True | False</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">recordExists</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="n">printerr</span><span class="p">(</span><span class="s1">&#39;record already exists&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># number of bytes per character changes per encoding</span>
            <span class="c1"># encode record name first and make sure we&#39;re within limits</span>
            <span class="n">name_enc</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">name_enc</span> <span class="o">=</span> <span class="n">name_enc</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name_size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">name_enc</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name_enc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_size</span><span class="p">:</span>
                <span class="n">printerr</span><span class="p">(</span><span class="s1">&#39;record name is invalid&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="c1"># number of bytes per integer varies in python (dynamic)</span>
            <span class="c1"># encode as 32bit unsigned integer for static size</span>
            <span class="n">a1_enc</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;I&#39;</span><span class="p">,</span> <span class="n">a1</span><span class="p">)</span>
            <span class="n">a2_enc</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;I&#39;</span><span class="p">,</span> <span class="n">a2</span><span class="p">)</span>
            <span class="n">a3_enc</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;I&#39;</span><span class="p">,</span> <span class="n">a3</span><span class="p">)</span>
            <span class="n">a4_enc</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;I&#39;</span><span class="p">,</span> <span class="n">a4</span><span class="p">)</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="n">printerr</span><span class="p">(</span><span class="s1">&#39;encoding failed.. invalid data&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">name_enc</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">a1_enc</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">a2_enc</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">a3_enc</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">a4_enc</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="MiniDB.updateRecord"><a class="viewcode-back" href="../index.html#minisql.MiniDB.updateRecord">[docs]</a>    <span class="k">def</span> <span class="nf">updateRecord</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">a1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">a2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">a3</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update a record in the database</span>

<span class="sd">        :param name: record name</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :param a1: field data</span>
<span class="sd">        :type a1: int</span>
<span class="sd">        :param a2: field data</span>
<span class="sd">        :type a2: int</span>
<span class="sd">        :param a3: field data</span>
<span class="sd">        :type a3: int</span>
<span class="sd">        :param a4: field data</span>
<span class="sd">        :type a4: int</span>
<span class="sd">        :return: True | False</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">a1_enc</span><span class="p">,</span> <span class="n">a2_enc</span><span class="p">,</span> <span class="n">a3_enc</span><span class="p">,</span> <span class="n">a4_enc</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">recordExists</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="n">printerr</span><span class="p">(</span><span class="s1">&#39;record does not exist&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">record_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># number of bytes per character changes per encoding</span>
            <span class="c1"># encode record name first and make sure we&#39;re within limits</span>
            <span class="n">name_enc</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">name_enc</span> <span class="o">=</span> <span class="n">name_enc</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name_size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">name_enc</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name_enc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_size</span><span class="p">:</span>
                <span class="n">printerr</span><span class="p">(</span><span class="s1">&#39;record name is invalid&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="c1"># number of bytes per integer varies in python (dynamic)</span>
            <span class="c1"># encode as 32bit unsigned integer for static size</span>
            <span class="k">if</span> <span class="n">a1</span><span class="p">:</span>
                <span class="n">a1_enc</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;I&#39;</span><span class="p">,</span> <span class="n">a1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">a2</span><span class="p">:</span>
                <span class="n">a2_enc</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;I&#39;</span><span class="p">,</span> <span class="n">a2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">a3</span><span class="p">:</span>
                <span class="n">a3_enc</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;I&#39;</span><span class="p">,</span> <span class="n">a3</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">a4</span><span class="p">:</span>
                <span class="n">a4_enc</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;I&#39;</span><span class="p">,</span> <span class="n">a4</span><span class="p">)</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="n">printerr</span><span class="p">(</span><span class="s1">&#39;encoding failed.. invalid data&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># if the transaction isnt rolled back above, go ahead and write</span>
        <span class="k">if</span> <span class="n">a1_enc</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_size</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">a1_enc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="n">offset</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">a2_enc</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_size</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_size</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">a2_enc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="n">offset</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">a3_enc</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_size</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">a3_enc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="n">offset</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">a4_enc</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_size</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">a4_enc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="n">offset</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="MiniDB.deleteRecord"><a class="viewcode-back" href="../index.html#minisql.MiniDB.deleteRecord">[docs]</a>    <span class="k">def</span> <span class="nf">deleteRecord</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete a record from the database</span>

<span class="sd">        :param name: record to delete</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :return: True | False</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">recordExists</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="n">printerr</span><span class="p">(</span><span class="s1">&#39;record does not exist&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># end of record</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_size</span>

        <span class="c1"># reading into memory and rewriting won&#39;t work with very large files</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">marker</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="o">.</span><span class="n">truncate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="MiniDB.deleteRecords"><a class="viewcode-back" href="../index.html#minisql.MiniDB.deleteRecords">[docs]</a>    <span class="k">def</span> <span class="nf">deleteRecords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete all records from the database</span>

<span class="sd">        :return: True | False</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="o">.</span><span class="n">truncate</span><span class="p">()</span></div>

<div class="viewcode-block" id="MiniDB.query"><a class="viewcode-back" href="../index.html#minisql.MiniDB.query">[docs]</a>    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_string</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Interface to query the database</span>

<span class="sd">        :param query_string: queries to run</span>
<span class="sd">        :return: True if they succeed, false if they fail</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpretQueries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parseQueries</span><span class="p">(</span><span class="n">query_string</span><span class="p">))</span></div>

<div class="viewcode-block" id="MiniDB.parseQueries"><a class="viewcode-back" href="../index.html#minisql.MiniDB.parseQueries">[docs]</a>    <span class="k">def</span> <span class="nf">parseQueries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_queries</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse input into interpretable queries based on a SQL-like syntax\n</span>
<span class="sd">        Queries are delimited by a semicolon and query commands are delimited by whitespace</span>

<span class="sd">        :param raw_queries: command string input</span>
<span class="sd">        :return: list of queries to execute</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">query_strings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">raw_queries</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">query_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">WHITE_SPACE_NOT_ENCLOSED</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="n">query_strings</span><span class="p">]</span></div>


<div class="viewcode-block" id="MiniDB.interpretQueries"><a class="viewcode-back" href="../index.html#minisql.MiniDB.interpretQueries">[docs]</a>    <span class="k">def</span> <span class="nf">interpretQueries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queries</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Interpret queries as a list of commands to execute in miniSQL language</span>

<span class="sd">        :param queries: list of queries to process</span>
<span class="sd">        :return: False to exit, True to continue (applicable to miniSQL shell)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="n">queries</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">cmd</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;quit&#39;</span><span class="p">}:</span>
                    <span class="k">return</span> <span class="kc">False</span>


                <span class="k">elif</span> <span class="n">cmd</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;help&#39;</span><span class="p">}:</span>
                    <span class="n">printShellUsage</span><span class="p">()</span>
                    <span class="k">return</span> <span class="kc">True</span>


                <span class="k">elif</span> <span class="n">cmd</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="s1">&#39;insert&#39;</span><span class="p">}:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">printerr</span><span class="p">(</span><span class="s2">&quot;insert command requires a record&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">True</span>

                    <span class="n">record_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="n">printerr</span><span class="p">(</span><span class="s2">&quot;insert command requires 4 values&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">True</span>

                    <span class="c1"># data type conversion and simple checks</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>

                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

                            <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">printerr</span><span class="p">(</span><span class="s2">&quot;insert command value &#39;</span><span class="si">{}</span><span class="s2">&#39; is invalid&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
                                <span class="k">return</span> <span class="kc">True</span>

                            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

                    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                        <span class="n">printerr</span><span class="p">(</span><span class="s2">&quot;insert command field type mismatch&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">True</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">createRecord</span><span class="p">(</span><span class="n">record_name</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Query successful! Record created..&#39;</span><span class="p">)</span>


                <span class="k">elif</span> <span class="n">cmd</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;retrieve&#39;</span><span class="p">}:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">printerr</span><span class="p">(</span><span class="s2">&quot;retrieve command requires a record&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">True</span>

                    <span class="n">record_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="n">headers</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Record Name&#39;</span><span class="p">,</span> <span class="s1">&#39;a1&#39;</span><span class="p">,</span> <span class="s1">&#39;a2&#39;</span><span class="p">,</span> <span class="s1">&#39;a3&#39;</span><span class="p">,</span> <span class="s1">&#39;a4&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">record_name</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
                        <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getRecords</span><span class="p">()</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">printTable</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="n">records</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">printwarn</span><span class="p">(</span><span class="s1">&#39;Query returned 0 results..&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getRecord</span><span class="p">(</span><span class="n">record_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">record</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">printTable</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="p">[</span><span class="n">record</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">printwarn</span><span class="p">(</span><span class="s1">&#39;Query returned 0 results..&#39;</span><span class="p">)</span>


                <span class="k">elif</span> <span class="n">cmd</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">}:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">printerr</span><span class="p">(</span><span class="s2">&quot;delete command requires a record&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">True</span>

                    <span class="n">record_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="k">if</span> <span class="n">record_name</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deleteRecords</span><span class="p">()</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Query successful! Records deleted..&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deleteRecord</span><span class="p">(</span><span class="n">record_name</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Query successful! Record deleted..&#39;</span><span class="p">)</span>


                <span class="k">elif</span> <span class="n">cmd</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">}:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">printerr</span><span class="p">(</span><span class="s2">&quot;update command requires a record&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">True</span>

                    <span class="n">record_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">printerr</span><span class="p">(</span><span class="s2">&quot;update command requires a field and value&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">True</span>

                    <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
                        <span class="n">kv_str</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">kv_pair</span> <span class="o">=</span> <span class="n">kv_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

                        <span class="c1"># make sure we got field and value</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kv_pair</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">printerr</span><span class="p">(</span><span class="s2">&quot;update command field or value missing&quot;</span><span class="p">)</span>
                            <span class="k">return</span> <span class="kc">True</span>

                        <span class="c1"># data type conversion and simple checks</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">kv_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kv_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">DB_ALLOWED_FIELDS</span><span class="p">:</span>
                                <span class="n">printerr</span><span class="p">(</span><span class="s2">&quot;update command field &#39;</span><span class="si">{}</span><span class="s2">&#39; is invalid&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kv_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                                <span class="k">return</span> <span class="kc">True</span>

                            <span class="k">elif</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">printerr</span><span class="p">(</span><span class="s2">&quot;update command value &#39;</span><span class="si">{}</span><span class="s2">&#39; is invalid&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kv_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                                <span class="k">return</span> <span class="kc">True</span>

                        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                            <span class="n">printerr</span><span class="p">(</span><span class="s2">&quot;update command key or value type mismatch&quot;</span><span class="p">)</span>
                            <span class="k">return</span> <span class="kc">True</span>

                        <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                        <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">updateRecord</span><span class="p">(</span><span class="n">record_name</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Query successful! Record updated..&#39;</span><span class="p">)</span>


                <span class="k">else</span><span class="p">:</span>
                    <span class="n">printerr</span><span class="p">(</span><span class="s1">&#39;command &quot;</span><span class="si">{}</span><span class="s1">&quot; is not recognized&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
                    <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">True</span></div></div>


<div class="viewcode-block" id="MiniShell"><a class="viewcode-back" href="../index.html#minisql.MiniShell">[docs]</a><span class="k">class</span> <span class="nc">MiniShell</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple shell-like interpreter for miniSQL queries</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">intro</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">SHELL_INTRO</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">SHELL_PROMPT</span>
    <span class="n">history_file</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">SHELL_HISTORY_FILE</span>
    <span class="n">history_len</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">SHELL_HISTORY_LENGTH</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setup shell variables and files for session</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history_file</span><span class="p">):</span>
            <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">MiniDB</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finalizer</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>

        <span class="c1"># import functools</span>
        <span class="c1"># global print</span>
        <span class="c1"># print = functools.partial(print, flush=True)</span>

        <span class="c1"># setup history file</span>
        <span class="n">readline</span><span class="o">.</span><span class="n">read_history_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history_file</span><span class="p">)</span>
        <span class="n">readline</span><span class="o">.</span><span class="n">set_history_length</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history_len</span><span class="p">)</span>

<div class="viewcode-block" id="MiniShell.close"><a class="viewcode-back" href="../index.html#minisql.MiniShell.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close database connection and cleanup</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">readline</span><span class="o">.</span><span class="n">write_history_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history_file</span><span class="p">)</span></div>

<div class="viewcode-block" id="MiniShell.complete"><a class="viewcode-back" href="../index.html#minisql.MiniShell.complete">[docs]</a>    <span class="k">def</span> <span class="nf">complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find all possible commands to complete text</span>

<span class="sd">        :param text:</span>
<span class="sd">        :param state:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">match_text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="n">options</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmd</span> <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">POSSIBLE_SHELL_COMMANDS</span> <span class="k">if</span> <span class="n">cmd</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">match_text</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">options</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">options</span><span class="p">[</span><span class="n">state</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="MiniShell.start"><a class="viewcode-back" href="../index.html#minisql.MiniShell.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start the shell command interpreter\n</span>
<span class="sd">        Accept commands until user quits program</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># setup auto complete</span>
        <span class="n">readline</span><span class="o">.</span><span class="n">parse_and_bind</span><span class="p">(</span><span class="s1">&#39;set enable-keypad on&#39;</span><span class="p">)</span>
        <span class="n">readline</span><span class="o">.</span><span class="n">set_completer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">complete</span><span class="p">)</span>
        <span class="n">readline</span><span class="o">.</span><span class="n">set_completer_delims</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">;&#39;</span><span class="p">)</span>
        <span class="n">readline</span><span class="o">.</span><span class="n">parse_and_bind</span><span class="p">(</span><span class="s2">&quot;tab: complete&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intro</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>

            <span class="c1"># get input cmds and parse</span>
            <span class="n">raw_queries</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prompt</span><span class="p">)</span>
            <span class="n">parsed_queries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">parseQueries</span><span class="p">(</span><span class="n">raw_queries</span><span class="p">)</span>

            <span class="c1"># DEBUG:</span>
            <span class="c1"># print(&quot;parsed commands: {}&quot;.format(parsed_queries))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">interpretQueries</span><span class="p">(</span><span class="n">parsed_queries</span><span class="p">):</span>
                <span class="k">break</span></div></div>

<span class="c1"># class MiniServer():</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     miniSQL DB Server</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     def __init__(self, host=&quot;0.0.0.0&quot;, port=8190, buff_size=4096, max_conn=5):</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         create a server instance</span>
<span class="c1">#</span>
<span class="c1">#         :param host:</span>
<span class="c1">#         :param port:</span>
<span class="c1">#         :param buff_size:</span>
<span class="c1">#         :param max_conn:</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#         self.host = host</span>
<span class="c1">#         self.port = port</span>
<span class="c1">#         self.buff_size = buff_size</span>
<span class="c1">#         self.max_conn = max_conn</span>
<span class="c1">#         self.db = MiniDB()</span>
<span class="c1">#</span>
<span class="c1">#     # def __exit__(self, exc_type, exc_val, exc_tb):</span>
<span class="c1">#</span>
<span class="c1">#     def recvall(self, conn):</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         receive all data from client</span>
<span class="c1">#</span>
<span class="c1">#         :param conn:</span>
<span class="c1">#         :return:</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#         data = &quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#         while True:</span>
<span class="c1">#             buff = conn.recv(self.buff_size)</span>
<span class="c1">#             if not buff or len(buff) == 0:</span>
<span class="c1">#                 break</span>
<span class="c1">#             data += buff.decode()</span>
<span class="c1">#</span>
<span class="c1">#         return data</span>
<span class="c1">#</span>
<span class="c1">#     def listen(self, callback=print):</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         listen for connections</span>
<span class="c1">#</span>
<span class="c1">#         :param callback:</span>
<span class="c1">#         :return:</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#         serversock = None</span>
<span class="c1">#</span>
<span class="c1">#         try:</span>
<span class="c1">#             serversock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span>
<span class="c1">#             serversock.bind((self.host, self.port))</span>
<span class="c1">#             serversock.listen(5)</span>
<span class="c1">#             printdbg(&quot;listening on {host}:{port}&quot;.format(host=self.host, port=str(self.port)))</span>
<span class="c1">#</span>
<span class="c1">#             while True:</span>
<span class="c1">#                 senddata = &quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#                 conn, srcaddr = serversock.accept()</span>
<span class="c1">#                 print(&#39;connection established from: {}&#39;.format(srcaddr))</span>
<span class="c1">#</span>
<span class="c1">#                 print(&quot;parsing request data&quot;)</span>
<span class="c1">#                 recvdata = self.recvall(conn)</span>
<span class="c1">#</span>
<span class="c1">#                 conn.sendall(senddata.encode())</span>
<span class="c1">#</span>
<span class="c1">#                 conn.close()</span>
<span class="c1">#                 print(&#39;connection to: {} closed&#39;.format(srcaddr))</span>
<span class="c1">#         finally:</span>
<span class="c1">#             serversock.close()</span>


<span class="c1"># TODO: exception handling, catch propogated signals here in try, catch block</span>
<div class="viewcode-block" id="main"><a class="viewcode-back" href="../index.html#minisql.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse command line arguments and decide how data is processed</span>

<span class="sd">    :return: 0 on success, 1 on failure</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="c1"># too many args present</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">printerr</span><span class="p">(</span><span class="s1">&#39;too many arguments&#39;</span><span class="p">)</span>
        <span class="n">printCmdUsage</span><span class="p">()</span>
        <span class="k">return</span> <span class="mi">1</span>

    <span class="c1"># if no args we need to further process data</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">is_readable</span> <span class="o">=</span> <span class="n">validateStdinReadable</span><span class="p">()</span>

        <span class="c1"># stdin can&#39;t be read from exit</span>
        <span class="k">if</span> <span class="n">is_readable</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">printerr</span><span class="p">(</span><span class="s1">&#39;stdin is not readable&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>

        <span class="c1"># process query if stdin is redirected</span>
        <span class="k">elif</span> <span class="n">is_readable</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">db</span> <span class="o">=</span> <span class="n">MiniDB</span><span class="p">()</span>
            <span class="c1"># TODO: buffer input</span>
            <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="c1"># start miniSQL shell if stdin is keyboard</span>
        <span class="k">elif</span> <span class="n">is_readable</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">MiniShell</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="c1"># something went wrong</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">printerr</span><span class="p">(</span><span class="s1">&#39;unknown error occurred&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>

    <span class="c1"># print usage</span>
    <span class="k">elif</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-h&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LOGO</span><span class="p">)</span>
        <span class="n">printCmdUsage</span><span class="p">()</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="c1"># print version</span>
    <span class="k">elif</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-v&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;miniSQL Version: </span><span class="si">{major}</span><span class="s1">.</span><span class="si">{minor}</span><span class="s1">.</span><span class="si">{patch}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">major</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">MAJOR_RELEASE_NUMBER</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">MINOR_RELEASE_NUMBER</span><span class="p">,</span> <span class="n">patch</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">PATCH_RELEASE_NUMBER</span>
        <span class="p">))</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="c1"># execute query string</span>
    <span class="k">elif</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-e&#39;</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">printerr</span><span class="p">(</span><span class="s1">&#39;missing required arguments&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">MiniDB</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="c1"># start db server</span>
    <span class="k">elif</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-s&#39;</span><span class="p">:</span>
        <span class="n">printerr</span><span class="p">(</span><span class="s1">&#39;not yet implemented&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span>
        <span class="c1"># args.pop(0)</span>
        <span class="c1"># if len(args) &lt; 1:</span>
        <span class="c1">#     printerr(&#39;missing required arguments&#39;)</span>
        <span class="c1">#     return 1</span>
        <span class="c1">#</span>
        <span class="c1"># server_info = args[0].split(&#39;:&#39;)</span>
        <span class="c1"># if len(server_info) &lt; 2:</span>
        <span class="c1">#     printerr(&#39;missing server info&#39;)</span>
        <span class="c1">#     return 1</span>
        <span class="c1">#</span>
        <span class="c1"># db = MiniDB()</span>
        <span class="c1"># db.query(args[0])</span>
        <span class="c1"># return 0</span>

    <span class="c1"># incorrect format or wrong args</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">printerr</span><span class="p">(</span><span class="s1">&#39;incorrect format&#39;</span><span class="p">)</span>
        <span class="n">printCmdUsage</span><span class="p">()</span>
        <span class="k">return</span> <span class="mi">1</span></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">miniSQL</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../requirements.html">1. Project Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../database_description.html">2. Database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../test_input.html">3. Test Queries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../storage_format.html">4. Storage Specification</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, DevOpSec.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>